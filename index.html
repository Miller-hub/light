<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°¤é”æ•¸ç† | Yodascience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
            overflow-x: hidden;
            touch-action: pan-y; /* å…è¨±å‚ç›´æ»¾å‹•ï¼Œä½†åœ¨Canvasä¸Šæœƒè¢«JSæ””æˆª */
        }

        /* å…‰åŠæ•ˆæœ */
        .glow-red { box-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444; }
        .glow-blue { box-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6; }
        
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
        }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-toggle.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
        }
        
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        input[type="checkbox"] { cursor: pointer; }

        /* ç•«ç­†é¡è‰²é¸æ“‡æ¨£å¼ */
        .color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
        .color-btn.active { transform: scale(1.2); border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- é ‚éƒ¨å°è¦½ -->
    <header class="w-full max-w-4xl flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-700 pb-4 gap-4">
        <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">
            ğŸ§ª å°¤é”æ•¸ç†
        </h1>
        <nav class="flex gap-2 bg-slate-800 p-1 rounded-xl">
            <button onclick="switchPage('sim')" id="nav-sim" class="px-4 py-2 rounded-lg text-sm font-bold bg-slate-700 hover:bg-slate-600 transition text-green-400 shadow-md">
                å¯¦é©—å®¤
            </button>
            <button onclick="switchPage('draw')" id="nav-draw" class="px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition text-slate-400">
                ç¹ªåœ–æ¿
            </button>
            <button onclick="switchPage('practice')" id="nav-practice" class="px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition text-slate-400">
                ç‰¹è¨“å ´
            </button>
        </nav>
    </header>

    <!-- ================= é é¢ 1: å‹•æ…‹æ¨¡æ“¬å™¨ (Simulator) ================= -->
    <main id="page-sim" class="w-full max-w-4xl flex flex-col gap-4 fade-in">
        <div class="bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-700 flex flex-col gap-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <label class="text-slate-400 whitespace-nowrap">å…ƒä»¶ï¼š</label>
                    <select id="simType" onchange="updateSimSettings()" class="w-full md:w-64 bg-slate-900 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:border-green-500 transition">
                        <option value="convex_lens">å‡¸é€é¡ (Convex Lens)</option>
                        <option value="concave_lens">å‡¹é€é¡ (Concave Lens)</option>
                        <option value="concave_mirror">å‡¹é¢é¡ (Concave Mirror)</option>
                        <option value="convex_mirror">å‡¸é¢é¡ (Convex Mirror)</option>
                        <option value="plane_mirror">å¹³é¢é¡ (Plane Mirror)</option>
                    </select>
                </div>
                <div class="text-sm text-slate-400 flex items-center gap-2">
                    <span class="inline-block w-3 h-3 bg-red-500 rounded-full glow-red"></span> ç‰©
                    <span class="inline-block w-3 h-3 bg-blue-500 rounded-full glow-blue ml-2"></span> åƒ
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-4 border-t border-slate-700 pt-3">
                <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">å…‰è·¯ï¼š</span>
                <label class="flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded bg-slate-900 border border-slate-600 hover:border-red-400 transition group">
                    <input type="checkbox" id="showRay1" class="accent-red-400 w-4 h-4" checked onchange="drawSim()">
                    <span class="text-red-300 text-sm font-medium group-hover:text-red-200">å¹³è¡Œä¸»è»¸éç„¦é»(ç´…)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded bg-slate-900 border border-slate-600 hover:border-green-400 transition group">
                    <input type="checkbox" id="showRay2" class="accent-green-400 w-4 h-4" checked onchange="drawSim()">
                    <span class="text-green-300 text-sm font-medium group-hover:text-green-200">éé¡å¿ƒä¸åæŠ˜(ç¶ )</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer px-3 py-1.5 rounded bg-slate-900 border border-slate-600 hover:border-blue-400 transition group">
                    <input type="checkbox" id="showRay3" class="accent-blue-400 w-4 h-4" checked onchange="drawSim()">
                    <span class="text-blue-300 text-sm font-medium group-hover:text-blue-200">éç„¦é»å¹³è¡Œä¸»è»¸(è—)</span>
                </label>
            </div>
        </div>

        <div class="relative w-full bg-black rounded-xl overflow-hidden border-2 border-slate-700 shadow-2xl" style="height: 400px;">
            <canvas id="simCanvas" class="w-full h-full cursor-move touch-none"></canvas>
            <div class="absolute bottom-4 left-4 bg-slate-900/80 backdrop-blur-sm px-4 py-2 rounded-lg border border-slate-700 pointer-events-none z-10">
                <div class="text-xs text-slate-400 mb-1">æˆåƒç‹€æ…‹</div>
                <div id="imageStatus" class="text-lg font-bold text-white">---</div>
                <div id="magRate" class="text-sm text-green-400 font-mono mt-1">---</div>
            </div>
            <div id="dragHint" class="absolute top-1/2 left-1/4 transform -translate-x-1/2 -translate-y-1/2 text-white/30 text-4xl animate-pulse pointer-events-none z-0">â†” <span class="text-sm block text-center">æ‹–æ›³</span></div>
        </div>
        <div class="flex justify-end">
             <button onclick="switchPage('draw')" class="group flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-full font-bold transition shadow-lg shadow-blue-900/50">
                è©¦è‘—è‡ªå·±ç•«ç•«çœ‹
                <span class="group-hover:translate-x-1 transition-transform">â†’</span>
            </button>
        </div>
    </main>

    <!-- ================= é é¢ 2: ç¹ªåœ–æ¿ (Drawing Board) ================= -->
    <main id="page-draw" class="hidden w-full max-w-4xl flex flex-col gap-4 fade-in">
        
        <!-- ç¹ªåœ–å·¥å…·åˆ— -->
        <div class="bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-700 flex flex-col md:flex-row gap-4 justify-between items-center">
             <div class="flex items-center gap-3 w-full md:w-auto">
                <label class="text-slate-400 whitespace-nowrap">é¡Œç›®ï¼š</label>
                <select id="drawType" onchange="resetDrawBoard()" class="w-full md:w-56 bg-slate-900 border border-slate-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:border-green-500 transition">
                    <option value="convex_lens">å‡¸é€é¡ (Convex Lens)</option>
                    <option value="concave_lens">å‡¹é€é¡ (Concave Lens)</option>
                    <option value="concave_mirror">å‡¹é¢é¡ (Concave Mirror)</option>
                    <option value="convex_mirror">å‡¸é¢é¡ (Convex Mirror)</option>
                </select>
            </div>

            <!-- ç•«ç­†å·¥å…· -->
            <div class="flex items-center gap-4 bg-slate-900 px-4 py-2 rounded-lg border border-slate-600">
                <span class="text-xs text-slate-400 font-bold uppercase mr-1">ç•«ç­†ï¼š</span>
                <button class="color-btn bg-red-400 active" onclick="setPenColor('#F87171', this)" title="ç´…å…‰ (å¹³è¡Œå…‰)"></button>
                <button class="color-btn bg-green-400" onclick="setPenColor('#4ADE80', this)" title="ç¶ å…‰ (éé¡å¿ƒ)"></button>
                <button class="color-btn bg-blue-400" onclick="setPenColor('#60A5FA', this)" title="è—å…‰ (éç„¦é»)"></button>
                <div class="w-px h-6 bg-slate-700 mx-2"></div>
                <button onclick="undoDraw()" class="text-slate-400 hover:text-white text-sm font-bold flex items-center gap-1">â†© å¾©åŸ</button>
                <button onclick="clearDrawLines()" class="text-slate-400 hover:text-red-400 text-sm font-bold flex items-center gap-1">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>

            <!-- é¡¯ç¤ºè§£ç­” -->
            <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded bg-slate-900 border border-slate-600 hover:border-yellow-400 transition">
                <input type="checkbox" id="showAnswer" class="accent-yellow-400 w-4 h-4" onchange="renderDrawBoard()">
                <span class="text-yellow-300 text-sm font-bold">é¡¯ç¤ºè§£ç­”</span>
            </label>
        </div>

        <div class="relative w-full bg-black rounded-xl overflow-hidden border-2 border-slate-700 shadow-2xl" style="height: 450px;">
            <canvas id="drawCanvas" class="w-full h-full cursor-crosshair touch-none"></canvas>
            
            <!-- æ“ä½œæŒ‡å¼• -->
            <div class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-sm px-4 py-2 rounded-lg border border-slate-700 pointer-events-none">
                <p class="text-slate-300 text-sm">ğŸ–±ï¸ <span class="text-white font-bold">æŒ‰ä½æ»‘é¼ </span> åœ¨ç•«å¸ƒä¸Šç•«å‡ºç›´ç·š</p>
                <p class="text-slate-400 text-xs mt-1">ğŸ’¡ æ‹–æ›³ <span class="text-red-500 font-bold">ç‰©é«”åº•éƒ¨(æ–‡å­—)</span> å¯ç§»å‹•ç‰©é«”</p>
            </div>
        </div>

        <div class="flex justify-between">
            <p class="text-slate-500 text-sm">* ç•«ç·šå°æ’‡æ­¥ï¼šå¾ç‰©é«”é ‚ç«¯é–‹å§‹ï¼Œç•«åˆ°é¡ç‰‡ï¼Œå†ç•«æŠ˜å°„/åå°„å¾Œçš„æ–¹å‘ã€‚</p>
            <button onclick="switchPage('practice')" class="group flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-full font-bold transition shadow-lg shadow-green-900/50">
                å»ç‰¹è¨“å€
                <span class="group-hover:translate-x-1 transition-transform">â†’</span>
            </button>
        </div>
    </main>

    <!-- ================= é é¢ 3: å–®å­—å¡ç·´ç¿’ (Drill) ================= -->
    <main id="page-practice" class="hidden w-full max-w-2xl flex flex-col gap-6 fade-in">
        <div class="flex items-center gap-4">
            <div class="flex-grow bg-slate-800 rounded-full h-2.5">
                <div id="progressBar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="text-sm text-slate-400 font-mono">Score: <span id="scoreDisplay" class="text-green-400 font-bold">0</span></div>
        </div>

        <div id="quizCard" class="bg-slate-800 border border-slate-700 rounded-2xl p-6 md:p-8 shadow-2xl relative min-h-[450px] flex flex-col">
            <div class="text-center mb-6">
                <div class="inline-block px-3 py-1 bg-slate-700 rounded-full text-xs text-slate-300 mb-3">
                    ç¬¬ <span id="qCurrent">1</span> / <span id="qTotal">10</span> é¡Œ
                </div>
                <h2 id="qType" class="text-2xl font-bold text-green-400 mb-2">å‡¸é€é¡</h2>
                <p class="text-lg text-slate-300">ç‰©é«”ä½ç½®ï¼š<span id="qPos" class="text-white font-bold border-b-2 border-green-500 pb-1">å…©å€ç„¦è·å¤–</span></p>
            </div>

            <div class="grid grid-cols-1 gap-5 flex-grow content-start" id="choicesArea">
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-slate-500 uppercase tracking-wider text-center font-bold">æ–¹å‘</span>
                    <div class="flex rounded-lg bg-slate-900 p-1 border border-slate-700">
                        <button onclick="selectOption('inv', 'æ­£ç«‹')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="inv" data-val="æ­£ç«‹">æ­£ç«‹</button>
                        <button onclick="selectOption('inv', 'å€’ç«‹')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="inv" data-val="å€’ç«‹">å€’ç«‹</button>
                    </div>
                </div>
                <div class="flex flex-col gap-1">
                    <span class="text-xs text-slate-500 uppercase tracking-wider text-center font-bold">å¤§å°</span>
                    <div class="flex rounded-lg bg-slate-900 p-1 border border-slate-700">
                        <button onclick="selectOption('size', 'æ”¾å¤§')" class="btn-toggle w-1/3 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="size" data-val="æ”¾å¤§">æ”¾å¤§</button>
                        <button onclick="selectOption('size', 'ç›¸ç­‰')" class="btn-toggle w-1/3 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="size" data-val="ç›¸ç­‰">ç›¸ç­‰</button>
                        <button onclick="selectOption('size', 'ç¸®å°')" class="btn-toggle w-1/3 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="size" data-val="ç¸®å°">ç¸®å°</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-slate-500 uppercase tracking-wider text-center font-bold">æ€§è³ª</span>
                        <div class="flex rounded-lg bg-slate-900 p-1 border border-slate-700">
                            <button onclick="selectOption('real', 'å¯¦åƒ')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="real" data-val="å¯¦åƒ">å¯¦åƒ</button>
                            <button onclick="selectOption('real', 'è™›åƒ')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="real" data-val="è™›åƒ">è™›åƒ</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <span class="text-xs text-slate-500 uppercase tracking-wider text-center font-bold">ä½ç½®</span>
                        <div class="flex rounded-lg bg-slate-900 p-1 border border-slate-700">
                            <button onclick="selectOption('side', 'åŒå´')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="side" data-val="åŒå´">åŒå´</button>
                            <button onclick="selectOption('side', 'ç•°å´')" class="btn-toggle w-1/2 py-3 rounded text-sm text-slate-400 hover:text-white transition font-medium" data-group="side" data-val="ç•°å´">ç•°å´</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="feedbackArea" class="hidden absolute inset-0 bg-slate-900/95 rounded-2xl z-20 flex flex-col items-center justify-center text-center p-6 backdrop-blur-sm">
                <div id="feedbackIcon" class="text-6xl mb-4 animate-bounce">ğŸ‰</div>
                <h3 id="feedbackTitle" class="text-2xl font-bold text-white mb-2">ç­”å°äº†ï¼</h3>
                <div class="text-left bg-slate-800 p-4 rounded-lg border border-slate-700 mb-6 w-full max-w-xs">
                    <p class="text-xs text-slate-400 mb-1">æ­£ç¢ºè§£ç­”ï¼š</p>
                    <p id="feedbackText" class="text-slate-200 text-sm font-mono leading-relaxed"></p>
                </div>
                <button onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg transition w-full md:w-auto">ä¸‹ä¸€é¡Œ &rarr;</button>
            </div>

            <div class="mt-6 text-center">
                <button onclick="checkAnswer()" class="w-full bg-green-600 hover:bg-green-500 text-white px-6 py-4 rounded-xl font-bold shadow-lg shadow-green-900/50 transition transform active:scale-95 text-lg tracking-wide">
                    ç¢ºèªç­”æ¡ˆ
                </button>
            </div>
        </div>
    </main>

    <script>
        // ==========================================
        // 1. å…¨å±€èˆ‡å°è¦½ (Global & Navigation)
        // ==========================================
        let currentPage = 'sim';

        function switchPage(page) {
            currentPage = page;
            ['sim', 'draw', 'practice'].forEach(p => {
                document.getElementById(`page-${p}`).classList.add('hidden');
                document.getElementById(`nav-${p}`).classList.remove('bg-slate-700', 'text-green-400', 'shadow-md');
                document.getElementById(`nav-${p}`).classList.add('text-slate-400');
            });

            document.getElementById(`page-${page}`).classList.remove('hidden');
            const navBtn = document.getElementById(`nav-${page}`);
            navBtn.classList.remove('text-slate-400');
            navBtn.classList.add('bg-slate-700', 'text-green-400', 'shadow-md');

            if (page === 'sim') setTimeout(resizeSimCanvas, 50);
            if (page === 'draw') setTimeout(initDrawBoard, 50);
            if (page === 'practice' && shuffledQuestions.length === 0) initPractice();
        }

        // å…±ç”¨ç‰©ç†åƒæ•¸ (Sim å’Œ Draw æ¨¡å¼åˆ†é–‹å„²å­˜ï¼Œä½†é‚è¼¯ç›¸ä¼¼)
        const commonH = 60;
        const commonF = 100;

        // ==========================================
        // 2. æ¨¡æ“¬å™¨é‚è¼¯ (Simulator Engine)
        // ==========================================
        const simCanvas = document.getElementById('simCanvas');
        const simCtx = simCanvas.getContext('2d');
        let simW, simH, simCX, simCY;
        
        let simObjX = -150; // Relative to center
        let simType = "convex_lens";
        let isSimDragging = false;

        function resizeSimCanvas() {
            if(simCanvas.parentElement) {
                simCanvas.width = simCanvas.parentElement.clientWidth;
                simCanvas.height = simCanvas.parentElement.clientHeight;
                simW = simCanvas.width; simH = simCanvas.height;
                simCX = simW / 2; simCY = simH / 2;
                drawSim();
            }
        }
        window.addEventListener('resize', () => { if(currentPage === 'sim') resizeSimCanvas(); if(currentPage === 'draw') resizeDrawCanvas(); });

        function updateSimSettings() {
            simType = document.getElementById('simType').value;
            drawSim();
        }

        function getFocalLength(type) {
             if (type === 'convex_lens' || type === 'concave_mirror') return commonF;
             if (type === 'concave_lens' || type === 'convex_mirror') return -commonF;
             return Infinity;
        }

        function calculateOptics(type, objX, f) {
            let p = Math.abs(objX);
            if (p === 0) p = 0.1;
            let q, m;
            if (type === 'plane_mirror') { q = -p; m = 1; }
            else { q = (p * f) / (p - f); m = -q / p; }
            return { q, m, p };
        }

        function drawSim() {
            // æ¸…é™¤èˆ‡åŸºç¤ç¹ªè£½
            simCtx.clearRect(0, 0, simW, simH);
            drawOpticalSystem(simCtx, simCX, simCY, simType, commonF);

            // è¨ˆç®—
            let f = getFocalLength(simType);
            let { q, m } = calculateOptics(simType, simObjX, f);
            
            // åº§æ¨™è½‰æ›
            let objVisX = simCX + simObjX;
            let imgVisX = simType.includes('lens') ? simCX + q : simCX - q;
            let imgH = commonH * m;

            // ç¹ªè£½å…‰è·¯ (è‹¥é–‹å•Ÿ)
            let showR1 = document.getElementById('showRay1').checked;
            let showR2 = document.getElementById('showRay2').checked;
            let showR3 = document.getElementById('showRay3').checked;
            
            if (!isNaN(q) && Math.abs(q) < 5000) {
                drawRayTracing(simCtx, simCX, simCY, objVisX, simCY - commonH, imgVisX, simCY - imgH, f, simType, showR1, showR2, showR3);
            }

            // ç¹ªè£½ç‰©åƒ
            drawObject(simCtx, objVisX, simCY, commonH, '#ef4444', 'ç‰©');
            
            // ç‹€æ…‹æ–‡å­—
            let statusText = "ä¸æˆåƒ";
            if (!isNaN(q) && Math.abs(q) < 5000) {
                let isVirtual = (q < 0);
                let nature = isVirtual ? "æ­£ç«‹è™›åƒ" : "å€’ç«‹å¯¦åƒ";
                if(simType === 'plane_mirror') nature = "æ­£ç«‹è™›åƒ";
                let size = Math.abs(m).toFixed(2) == 1.00 ? "ç›¸ç­‰" : (Math.abs(m) > 1 ? "æ”¾å¤§" : "ç¸®å°");
                statusText = `${nature} (${size})`;
                
                simCtx.save();
                if(isVirtual) simCtx.globalAlpha = 0.6;
                drawObject(simCtx, imgVisX, simCY, imgH, '#3b82f6', 'åƒ');
                simCtx.restore();
                
                let colorClass = isVirtual ? "text-amber-400" : "text-green-400";
                document.getElementById('imageStatus').className = `text-lg font-bold ${colorClass}`;
            } else {
                 document.getElementById('imageStatus').className = "text-lg font-bold text-slate-400";
            }
            document.getElementById('imageStatus').innerText = statusText;
            document.getElementById('magRate').innerText = (Math.abs(m) || 0).toFixed(2) + "x";
        }

        // Sim Dragging Logic
        simCanvas.addEventListener('mousedown', e => { if(Math.abs(e.offsetX - (simCX + simObjX)) < 40) isSimDragging = true; });
        simCanvas.addEventListener('mousemove', e => { 
            if(isSimDragging) { 
                simObjX = Math.min(-10, e.offsetX - simCX); 
                drawSim(); 
                document.getElementById('dragHint').style.display='none';
            } 
        });
        window.addEventListener('mouseup', () => isSimDragging = false);
        simCanvas.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            let tx = e.touches[0].clientX - simCanvas.getBoundingClientRect().left;
            if(Math.abs(tx - (simCX + simObjX)) < 40) isSimDragging = true;
        }, {passive:false});
        simCanvas.addEventListener('touchmove', e => { 
            e.preventDefault(); 
            if(isSimDragging) {
                let tx = e.touches[0].clientX - simCanvas.getBoundingClientRect().left;
                simObjX = Math.min(-10, tx - simCX);
                drawSim();
                document.getElementById('dragHint').style.display='none';
            }
        }, {passive:false});
        simCanvas.addEventListener('touchend', () => isSimDragging = false);


        // ==========================================
        // 3. ç¹ªåœ–æ¿é‚è¼¯ (Drawing Board Logic)
        // ==========================================
        const drawCanvas = document.getElementById('drawCanvas');
        const drawCtx = drawCanvas.getContext('2d');
        let drawW, drawH, drawCX, drawCY;
        
        let drawObjX = -150; 
        let drawType = "convex_lens";
        let userLines = []; // {x1, y1, x2, y2, color}
        let isDrawing = false;
        let isMovingObj = false;
        let startPoint = null;
        let penColor = '#F87171'; // Default Red

        function initDrawBoard() { resizeDrawCanvas(); }
        
        function resizeDrawCanvas() {
            if(drawCanvas.parentElement) {
                drawCanvas.width = drawCanvas.parentElement.clientWidth;
                drawCanvas.height = drawCanvas.parentElement.clientHeight;
                drawW = drawCanvas.width; drawH = drawCanvas.height;
                drawCX = drawW / 2; drawCY = drawH / 2;
                renderDrawBoard();
            }
        }

        function resetDrawBoard() {
            drawType = document.getElementById('drawType').value;
            userLines = [];
            // drawObjX = -150; // Keep object pos or reset? Let's keep it user friendly, don't jump.
            renderDrawBoard();
        }

        function setPenColor(color, btn) {
            penColor = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function undoDraw() { userLines.pop(); renderDrawBoard(); }
        function clearDrawLines() { userLines = []; renderDrawBoard(); }

        function renderDrawBoard() {
            drawCtx.clearRect(0, 0, drawW, drawH);
            
            // 1. ç•«èƒŒæ™¯ç³»çµ± (è»¸ã€é¡ç‰‡ã€ç„¦é»)
            drawOpticalSystem(drawCtx, drawCX, drawCY, drawType, commonF);

            // 2. è‹¥é–‹å•Ÿè§£ç­”ï¼Œç•«æ­£ç¢ºå…‰è·¯ (æ·¡è‰²è™›ç·š)
            if (document.getElementById('showAnswer').checked) {
                let f = getFocalLength(drawType);
                let { q, m } = calculateOptics(drawType, drawObjX, f);
                let objVisX = drawCX + drawObjX;
                let imgVisX = drawType.includes('lens') ? drawCX + q : drawCX - q;
                let imgH = commonH * m;
                
                drawCtx.save();
                drawCtx.globalAlpha = 0.3;
                drawCtx.setLineDash([5, 5]); // è™›ç·šæ¨¡å¼
                // ç•«ä¸‰æ¢æ¨™æº–ç·šä½œç‚ºåƒè€ƒ
                if (!isNaN(q) && Math.abs(q) < 5000) {
                     drawRayTracing(drawCtx, drawCX, drawCY, objVisX, drawCY - commonH, imgVisX, drawCY - imgH, f, drawType, true, true, true);
                     // ç•«åƒ
                     drawObject(drawCtx, imgVisX, drawCY, imgH, '#3b82f6', 'åƒ');
                }
                drawCtx.restore();
            }

            // 3. ç•«ç‰©é«”
            drawObject(drawCtx, drawCX + drawObjX, drawCY, commonH, '#ef4444', 'ç‰©');

            // 4. ç•«ä½¿ç”¨è€…ç•«çš„ç·š
            drawCtx.lineCap = "round";
            drawCtx.lineWidth = 3;
            userLines.forEach(line => {
                drawCtx.strokeStyle = line.color;
                drawCtx.beginPath();
                drawCtx.moveTo(line.x1, line.y1);
                drawCtx.lineTo(line.x2, line.y2);
                drawCtx.stroke();
            });

            // 5. ç•«æ­£åœ¨ç•«çš„é‚£æ¢ç·š (Preview)
            if (isDrawing && startPoint) {
                drawCtx.strokeStyle = penColor;
                drawCtx.lineWidth = 3;
                drawCtx.beginPath();
                drawCtx.moveTo(startPoint.x, startPoint.y);
                // é€™è£¡æˆ‘å€‘éœ€è¦ç•¶å‰æ»‘é¼ ä½ç½®ï¼Œä½†åœ¨ render loop è£¡æ‹¿ä¸åˆ°ï¼Œé€šå¸¸åœ¨ event è™•ç†
                // ç°¡åŒ–ï¼šåœ¨ mousemove ç›´æ¥ç•«ï¼Œé€™è£¡åªè² è²¬éœæ…‹é‡ç¹ª
            }
        }

        // Draw Canvas Events
        function getDrawPos(e) {
            const rect = drawCanvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function handleDrawStart(e) {
            const pos = getDrawPos(e);
            
            // æ”¹ç‚ºåˆ¤å®šç‰©é«”ã€Œåº•éƒ¨ã€ï¼ˆæ–‡å­—è™•ï¼‰æ‰è§¸ç™¼ç§»å‹•ï¼Œé¿å…èˆ‡é ‚ç«¯ç•«ç·šè¡çª
            let objBaseX = drawCX + drawObjX;
            let objBaseY = drawCY; 
            
            // åº•éƒ¨æ„Ÿæ‡‰å€ï¼šXÂ±20, Yåœ¨è»¸ç·šé™„è¿‘åŠä¸‹æ–¹ (ä¾‹å¦‚ -30 ~ +30)
            if (Math.abs(pos.x - objBaseX) < 20 && Math.abs(pos.y - objBaseY) < 30) {
                isMovingObj = true;
                drawCanvas.style.cursor = 'move';
            } else {
                isDrawing = true;
                startPoint = pos;
                drawCanvas.style.cursor = 'crosshair';
            }
        }

        function handleDrawMove(e) {
            const pos = getDrawPos(e);

            if (isMovingObj) {
                drawObjX = Math.min(-10, pos.x - drawCX);
                renderDrawBoard();
            } else if (isDrawing) {
                renderDrawBoard(); // æ¸…é™¤èˆŠçš„é è¦½
                
                // === æ–°å¢ï¼šç¹ªè£½è¼”åŠ©å»¶é•·ç·š ===
                let dx = pos.x - startPoint.x;
                let dy = pos.y - startPoint.y;
                let len = Math.sqrt(dx*dx + dy*dy);

                if (len > 5) { // åªæœ‰ç•¶ç•«äº†ä¸€å°æ®µå¾Œæ‰é¡¯ç¤ºè¼”åŠ©ç·šï¼Œé¿å…æŠ–å‹•
                    drawCtx.save();
                    drawCtx.strokeStyle = penColor;
                    drawCtx.globalAlpha = 0.2; // å¾ˆæ·¡
                    drawCtx.setLineDash([5, 5]); // è™›ç·š
                    drawCtx.lineWidth = 1;
                    
                    let uDx = dx / len;
                    let uDy = dy / len;
                    
                    // å»¶ä¼¸åˆ°ç•«å¸ƒå¤–
                    const EXT_LEN = 2000;
                    
                    drawCtx.beginPath();
                    // å¾èµ·é»å¾€å¾Œå»¶ä¼¸
                    drawCtx.moveTo(startPoint.x - uDx * EXT_LEN, startPoint.y - uDy * EXT_LEN);
                    // å¾€çµ‚é»å»¶ä¼¸
                    drawCtx.lineTo(startPoint.x + uDx * EXT_LEN, startPoint.y + uDy * EXT_LEN);
                    drawCtx.stroke();
                    drawCtx.restore();
                }
                // ==========================
                
                // ç•«é è¦½ç·š
                drawCtx.strokeStyle = penColor;
                drawCtx.lineWidth = 3;
                drawCtx.beginPath();
                drawCtx.moveTo(startPoint.x, startPoint.y);
                drawCtx.lineTo(pos.x, pos.y);
                drawCtx.stroke();
            } else {
                // Hover effect logic (cursor) - åƒ…åº•éƒ¨è§¸ç™¼ Move cursor
                let objBaseX = drawCX + drawObjX;
                if (Math.abs(pos.x - objBaseX) < 20 && Math.abs(pos.y - drawCY) < 30) {
                    drawCanvas.style.cursor = 'move';
                } else {
                    drawCanvas.style.cursor = 'crosshair';
                }
            }
        }

        function handleDrawEnd(e) {
            if (isMovingObj) {
                isMovingObj = false;
            } else if (isDrawing) {
                isDrawing = false;
            }
            renderDrawBoard();
        }
        
        // ç‚ºäº†æ­£ç¢ºç²å– DrawEnd çš„åº§æ¨™ï¼Œæˆ‘å€‘éœ€è¦åœ¨ Move æ™‚è¨˜éŒ„
        let lastDrawPos = null;
        drawCanvas.addEventListener('mousedown', e => { handleDrawStart(e); lastDrawPos = getDrawPos(e); });
        drawCanvas.addEventListener('mousemove', e => { handleDrawMove(e); lastDrawPos = getDrawPos(e); });
        window.addEventListener('mouseup', e => {
            if(isDrawing && lastDrawPos) {
                userLines.push({ x1: startPoint.x, y1: startPoint.y, x2: lastDrawPos.x, y2: lastDrawPos.y, color: penColor });
            }
            isDrawing = false; isMovingObj = false; renderDrawBoard();
        });

        drawCanvas.addEventListener('touchstart', e => { e.preventDefault(); handleDrawStart(e); lastDrawPos = getDrawPos(e); }, {passive:false});
        drawCanvas.addEventListener('touchmove', e => { e.preventDefault(); handleDrawMove(e); lastDrawPos = getDrawPos(e); }, {passive:false});
        drawCanvas.addEventListener('touchend', e => {
            if(isDrawing && lastDrawPos) {
                userLines.push({ x1: startPoint.x, y1: startPoint.y, x2: lastDrawPos.x, y2: lastDrawPos.y, color: penColor });
            }
            isDrawing = false; isMovingObj = false; renderDrawBoard();
        });


        // ==========================================
        // 4. ç¹ªåœ–è¼”åŠ©å‡½æ•¸ (Shared Rendering)
        // ==========================================
        
        function drawOpticalSystem(ctx, cx, cy, type, f) {
            let width = ctx.canvas.width;
            
            // å…‰è»¸
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(width, cy); ctx.stroke();

            // å…ƒä»¶
            ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 4;
            ctx.shadowBlur = 10; ctx.shadowColor = '#22d3ee';
            ctx.beginPath();
            if (type.includes('mirror') && type !== 'plane_mirror') {
                let curve = (type === 'concave_mirror') ? -20 : 20;
                ctx.moveTo(cx, cy - 100); ctx.quadraticCurveTo(cx + curve, cy, cx, cy + 100);
            } else if (type === 'plane_mirror') {
                ctx.moveTo(cx, cy - 100); ctx.lineTo(cx, cy + 100);
            } else {
                ctx.moveTo(cx, cy - 100); ctx.lineTo(cx, cy + 100);
                if (type === 'convex_lens') {
                    ctx.moveTo(cx-10, cy-90); ctx.lineTo(cx, cy-100); ctx.lineTo(cx+10, cy-90);
                    ctx.moveTo(cx-10, cy+90); ctx.lineTo(cx, cy+100); ctx.lineTo(cx+10, cy+90);
                } else {
                    ctx.moveTo(cx-10, cy-100); ctx.lineTo(cx, cy-90); ctx.lineTo(cx+10, cy-100);
                    ctx.moveTo(cx-10, cy+100); ctx.lineTo(cx, cy+90); ctx.lineTo(cx+10, cy+100);
                }
            }
            ctx.stroke(); ctx.shadowBlur = 0;

            // ç„¦é» F
            if (type !== 'plane_mirror') {
                ctx.fillStyle = '#fbbf24'; ctx.font = '12px sans-serif';
                let fAbs = Math.abs(f);
                [fAbs, 2*fAbs].forEach(dist => {
                    [1, -1].forEach(sign => {
                        ctx.beginPath(); ctx.arc(cx + dist * sign, cy, 3, 0, Math.PI*2); ctx.fill();
                    });
                });
                ctx.fillText("F", cx - fAbs - 5, cy + 20);
                if(type.includes('lens')) ctx.fillText("F'", cx + fAbs - 5, cy + 20);
            }
        }

        function drawObject(ctx, x, y, h, color, label) {
            ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.lineCap = "round";
            ctx.shadowBlur = 15; ctx.shadowColor = color;
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y - h); ctx.stroke();
            ctx.fillStyle = color; ctx.beginPath(); ctx.arc(x, y - h, 3, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0; ctx.font = "bold 14px sans-serif"; ctx.fillText(label, x - 6, y + 20);
        }

        // å…‰è·¯è¨ˆç®—èˆ‡ç¹ªè£½ (The Physics Engine)
        function drawRayTracing(ctx, cx, cy, ox, oy, ix, iy, f, type, r1, r2, r3) {
            let fAbs = Math.abs(f);
            ctx.lineWidth = 1.5; ctx.lineJoin = 'round';
            
            const drawOneRay = (start, mid, end, color) => {
                ctx.strokeStyle = color; ctx.setLineDash([]);
                ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(mid.x, mid.y); ctx.stroke(); // å…¥å°„
                
                // å‡ºå°„ (å»¶é•·)
                let dx = end.x - mid.x; let dy = end.y - mid.y;
                let len = Math.sqrt(dx*dx + dy*dy);
                if (len === 0) return;
                let farX = mid.x + (dx/len) * 1000;
                let farY = mid.y + (dy/len) * 1000;
                ctx.beginPath(); ctx.moveTo(mid.x, mid.y); ctx.lineTo(farX, farY); ctx.stroke();

                // è™›åƒåå‘è¿½è¹¤ç·š
                ctx.setLineDash([5, 5]); ctx.strokeStyle = color.replace(')', ', 0.4)').replace('rgb', 'rgba');
                ctx.beginPath(); ctx.moveTo(mid.x, mid.y); ctx.lineTo(ix, iy); ctx.stroke();
                ctx.setLineDash([]);
            };

            // Ray 1: å¹³è¡Œ -> ç„¦é»
            if (r1) {
                let mid = {x: cx, y: oy};
                let target;
                if (type === 'convex_lens') target = {x: cx + fAbs, y: cy};
                else if (type === 'concave_lens') { // ç™¼æ•£è‡ªå·¦ç„¦
                    let dx = mid.x - (cx - fAbs); let dy = mid.y - cy; target = {x: mid.x + dx, y: mid.y + dy};
                } else if (type === 'concave_mirror') target = {x: cx - fAbs, y: cy};
                else if (type === 'convex_mirror') { // ç™¼æ•£è‡ªå¾Œç„¦
                    let dx = mid.x - (cx + fAbs); let dy = mid.y - cy; target = {x: mid.x + dx, y: mid.y + dy};
                } else target = {x: ox, y: oy}; // Plane
                drawOneRay({x: ox, y: oy}, mid, target, '#FCA5A5');
            }
            
            // Ray 2: é¡å¿ƒ
            if (r2) {
                let mid = {x: cx, y: cy};
                let target;
                if (type.includes('lens')) { // ç›´ç©¿
                    let dx = mid.x - ox; let dy = mid.y - oy; target = {x: mid.x + dx, y: mid.y + dy};
                } else { // åå°„
                    let dx = mid.x - ox; let dy = mid.y - oy; target = {x: mid.x - dx, y: mid.y + dy};
                }
                drawOneRay({x: ox, y: oy}, mid, target, '#86EFAC');
            }

            // Ray 3: ç„¦é» -> å¹³è¡Œ
            if (r3 && type !== 'plane_mirror') {
                let tfX = (type === 'convex_lens' || type === 'concave_mirror') ? cx - fAbs : cx + fAbs;
                let m = (cy - oy) / (tfX - ox);
                let midY = oy + m * (cx - ox);
                if (Math.abs(midY - cy) < 200) {
                    let mid = {x: cx, y: midY};
                    let tx = type.includes('lens') ? cx + 100 : cx - 100;
                    drawOneRay({x: ox, y: oy}, mid, {x: tx, y: midY}, '#93C5FD');
                }
            }
        }


        // ==========================================
        // 5. ç‰¹è¨“æ¨¡å¼é‚è¼¯ (Drill)
        // ==========================================
        const questionBank = [
            { type: "å‡¸é€é¡", pos: "å…©å€ç„¦è·å¤– (2Få¤–)",   ans: { inv: "å€’ç«‹", size: "ç¸®å°", real: "å¯¦åƒ", side: "ç•°å´" } },
            { type: "å‡¸é€é¡", pos: "å‰›å¥½åœ¨ 2F",          ans: { inv: "å€’ç«‹", size: "ç›¸ç­‰", real: "å¯¦åƒ", side: "ç•°å´" } },
            { type: "å‡¸é€é¡", pos: "F èˆ‡ 2F ä¹‹é–“",       ans: { inv: "å€’ç«‹", size: "æ”¾å¤§", real: "å¯¦åƒ", side: "ç•°å´" } },
            { type: "å‡¸é€é¡", pos: "ç„¦é»å…§ (<F)",        ans: { inv: "æ­£ç«‹", size: "æ”¾å¤§", real: "è™›åƒ", side: "åŒå´" } },
            { type: "å‡¹é€é¡", pos: "ä»»æ„ä½ç½®",           ans: { inv: "æ­£ç«‹", size: "ç¸®å°", real: "è™›åƒ", side: "åŒå´" } },
            { type: "å‡¹é¢é¡", pos: "å…©å€ç„¦è·å¤– (2Få¤–)",   ans: { inv: "å€’ç«‹", size: "ç¸®å°", real: "å¯¦åƒ", side: "åŒå´" } },
            { type: "å‡¹é¢é¡", pos: "å‰›å¥½åœ¨ 2F",          ans: { inv: "å€’ç«‹", size: "ç›¸ç­‰", real: "å¯¦åƒ", side: "åŒå´" } },
            { type: "å‡¹é¢é¡", pos: "F èˆ‡ 2F ä¹‹é–“",       ans: { inv: "å€’ç«‹", size: "æ”¾å¤§", real: "å¯¦åƒ", side: "åŒå´" } },
            { type: "å‡¹é¢é¡", pos: "ç„¦é»å…§ (<F)",        ans: { inv: "æ­£ç«‹", size: "æ”¾å¤§", real: "è™›åƒ", side: "ç•°å´" } },
            { type: "å‡¸é¢é¡", pos: "ä»»æ„ä½ç½®",           ans: { inv: "æ­£ç«‹", size: "ç¸®å°", real: "è™›åƒ", side: "ç•°å´" } },
        ];
        let currentQIndex = 0;
        let score = 0;
        let currentSelection = { inv: null, size: null, real: null, side: null };
        let shuffledQuestions = [];

        function initPractice() {
            shuffledQuestions = [...questionBank].sort(() => Math.random() - 0.5);
            currentQIndex = 0; score = 0;
            document.getElementById('scoreDisplay').innerText = score;
            document.getElementById('qTotal').innerText = shuffledQuestions.length;
            loadQuestion();
        }
        function loadQuestion() {
            let q = shuffledQuestions[currentQIndex];
            document.getElementById('qCurrent').innerText = currentQIndex + 1;
            document.getElementById('qType').innerText = q.type;
            document.getElementById('qPos').innerText = q.pos;
            document.getElementById('progressBar').style.width = `${(currentQIndex / shuffledQuestions.length) * 100}%`;
            currentSelection = { inv: null, size: null, real: null, side: null };
            document.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            document.getElementById('feedbackArea').classList.add('hidden');
        }
        function selectOption(group, val) {
            currentSelection[group] = val;
            document.querySelectorAll(`button[data-group="${group}"]`).forEach(btn => {
                if (btn.dataset.val === val) btn.classList.add('active'); else btn.classList.remove('active');
            });
        }
        function checkAnswer() {
            if (Object.values(currentSelection).includes(null)) {
                document.getElementById('choicesArea').classList.add('shake');
                setTimeout(() => document.getElementById('choicesArea').classList.remove('shake'), 500);
                return;
            }
            let q = shuffledQuestions[currentQIndex];
            let isCorrect = true;
            for (let key in q.ans) if (currentSelection[key] !== q.ans[key]) isCorrect = false;
            
            const fbArea = document.getElementById('feedbackArea');
            fbArea.classList.remove('hidden');
            if (isCorrect) {
                score += 100; document.getElementById('scoreDisplay').innerText = score;
                document.getElementById('feedbackIcon').innerText = "ğŸ‰";
                document.getElementById('feedbackTitle').innerText = "å®Œå…¨æ­£ç¢ºï¼";
                document.getElementById('feedbackTitle').className = "text-2xl font-bold text-green-400 mb-2";
                document.getElementById('feedbackText').innerHTML = "å…‰å­¸è§€å¿µæ»¿åˆ†ï¼";
            } else {
                document.getElementById('feedbackIcon').innerText = "âš ï¸";
                document.getElementById('feedbackTitle').innerText = "åŠ æ²¹ï¼Œå†è©¦è©¦ï¼";
                document.getElementById('feedbackTitle').className = "text-2xl font-bold text-red-400 mb-2";
                document.getElementById('feedbackText').innerHTML = `
                    <div class="flex justify-between border-b border-slate-600 py-1"><span>æ–¹å‘</span> <span class="text-white">${q.ans.inv}</span></div>
                    <div class="flex justify-between border-b border-slate-600 py-1"><span>å¤§å°</span> <span class="text-white">${q.ans.size}</span></div>
                    <div class="flex justify-between border-b border-slate-600 py-1"><span>è™›å¯¦</span> <span class="text-white">${q.ans.real}</span></div>
                    <div class="flex justify-between py-1"><span>ä½ç½®</span> <span class="text-white">${q.ans.side}</span></div>`;
            }
        }
        function nextQuestion() {
            currentQIndex++;
            if (currentQIndex >= shuffledQuestions.length) { alert(`ç‰¹è¨“çµæŸï¼ç¸½åˆ†ï¼š${score}`); initPractice(); }
            else loadQuestion();
        }

        // ==========================================
        // 6. åˆå§‹åŒ– (Initialization)
        // ==========================================
        // ç¢ºä¿ç¶²é è¼‰å…¥å¾Œç«‹å³åŸ·è¡Œä¸€æ¬¡åˆå§‹åŒ–
        window.addEventListener('load', () => {
            switchPage('sim');
        });
    </script>
</body>
</html>